
--[[
 █████╗ ███╗   ██╗████████╗██╗      ███████╗██╗  ██╗██████╗ ██╗      ██████╗ ██╗████████╗
██╔══██╗████╗  ██║╚══██╔══╝██║      ██╔════╝╚██╗██╔╝██╔══██╗██║     ██╔═══██╗██║╚══██╔══╝
███████║██╔██╗ ██║   ██║   ██║█████╗█████╗   ╚███╔╝ ██████╔╝██║     ██║   ██║██║   ██║   
██╔══██║██║╚██╗██║   ██║   ██║╚════╝██╔══╝   ██╔██╗ ██╔═══╝ ██║     ██║   ██║██║   ██║   
██║  ██║██║ ╚████║   ██║   ██║      ███████╗██╔╝ ██╗██║     ███████╗╚██████╔╝██║   ██║   
╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝   ╚═╝      ╚══════╝╚═╝  ╚═╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝   ╚═╝   
\\ version: 1/31/2021 //

For more Information Please Look At My DevForum Post About It:
https://devforum.roblox.com/t/anti-exploit-framework-unknownparabellum/721362/32

//How To Get Started\\
1.Create a new Script

2.Move the Script to ServerScriptStorage

3.Copy and paste this into the script:

local AntiExploit = require(script.AntiExploitModule)
AntiExploit:Start()

4. And after that you are set!
                                                                                 
]]

local Knit = require(game:GetService("ReplicatedStorage").Knit)

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local PlayerClass = require(script.PlayerClass)
local Utils = Knit.Util

local ThreadUtil = require(Utils.Thread)
local Maid = require(Utils.Maid)

local AntiExploit = {}

AntiExploit.PlayersMonitoring = {}
AntiExploit.FlaggedPlayers = {} 
AntiExploit.Config = {
	["Increment"] = 0.05,
}
AntiExploit._maid = Maid.new()

AntiExploit.Started = false

function AntiExploit:AddPlayer(plr) --Adds a player to PlayersMonitoring, queueing them up to be monitored
	--Here is where you should add any exceptions for Admins.
	local obj = PlayerClass.new(plr)
	self.PlayersMonitoring[plr.Name] = obj
	self._maid[plr.UserId] = obj

	
end

function AntiExploit:RemovePlayer(plr)
	self._maid[plr.UserId] = nil
	self.PlayersMonitoring[plr.Name] = nil
	self.FlaggedPlayers[plr.Name] = nil
end

function AntiExploit:Start()
	if self.Started then
		warn("Anti-Exploit Already Started")
		return
	end
	self.Started = true	
	print("Started Anti Exploit")
	
	for _,plr in pairs(Players:GetPlayers())do
		self:AddPlayer(plr)
	end
	
	self._maid["PlayerAdded"] = Players.PlayerAdded:Connect(function(plr)
		self:AddPlayer(plr)
	end)
	self._maid["PlayerRemoved"] = Players.PlayerRemoving:Connect(function(plr)
		self:RemovePlayer(plr)
	end)	
	self._maid["RepeatingChecks"] = ThreadUtil.DelayRepeat(self.Config.Increment,
		function()
			for name,player in pairs(AntiExploit.PlayersMonitoring)do
				player:Update()
				if player.Flags.NumberOfFlags > 5 then
					if not AntiExploit.FlaggedPlayers[player.Info.Name] then
						warn(player.Info.Name.." has exeeded 5 flags...")
						AntiExploit.FlaggedPlayers[player.Info.Name] = player
					end
				end
			end	
		end
	)
end



function AntiExploit:Stop()
	if not self.Started then
		warn("Anti-Exploit Already Stopped")
		return
	end
	self.Started = false
	warn("Anti-Exploit Stopped")
	self._maid:DoCleaning()
	self.PlayersMonitoring = {}
	self.FlaggedPlayers = {}
end

return AntiExploit
